name: ğŸ—ï¸ Build SINUX APK
on: 
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly build

jobs:
  build-android-apk:
    name: ğŸ Python â†’ ğŸ¤– Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    strategy:
      matrix:
        python-version: ['3.9']
    
    steps:
    # 1. CHECKOUT
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    # 2. SETUP PYTHON
    - name: ğŸ Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    # 3. INSTALL SYSTEM DEPS
    - name: âš™ï¸ Install System Dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
          python3-pip \
          python3-dev \
          git \
          wget \
          curl \
          unzip \
          zip \
          openjdk-11-jdk \
          build-essential \
          ccache \
          libffi-dev \
          libssl-dev \
          libxml2-dev \
          libxslt1-dev \
          libjpeg-dev \
          zlib1g-dev \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev \
          libsdl2-ttf-dev
      timeout-minutes: 5
    
    # 4. INSTALL PYTHON DEPS
    - name: ğŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip wheel setuptools
        python -m pip install cython==0.29.33 virtualenv
        python -m pip install buildozer
    
    # 5. CREATE buildozer.spec (SIMPLIFIED - NO HEREDOC)
    - name: âš™ï¸ Create Build Configuration
      run: |
        echo '[app]' > buildozer.spec
        echo 'title = SINUX OS' >> buildozer.spec
        echo 'package.name = sinux' >> buildozer.spec
        echo 'package.domain = org.simontech' >> buildozer.spec
        echo 'source.dir = .' >> buildozer.spec
        echo 'source.include_exts = py,png,jpg,kv,atlas' >> buildozer.spec
        echo 'version = 2.0.0' >> buildozer.spec
        echo 'requirements = python3' >> buildozer.spec
        echo 'orientation = portrait' >> buildozer.spec
        echo 'fullscreen = 0' >> buildozer.spec
        echo 'android.api = 33' >> buildozer.spec
        echo 'android.minapi = 21' >> buildozer.spec
        echo 'android.ndk = 23b' >> buildozer.spec
        echo 'android.sdk = 33' >> buildozer.spec
        echo 'android.permissions = INTERNET' >> buildozer.spec
        echo 'android.arch = arm64-v8a,armeabi-v7a' >> buildozer.spec
        echo 'p4a.branch = develop' >> buildozer.spec
    
    # 6. PREPARE ANDROID SDK (PRE-DOWNLOAD)
    - name: ğŸ¤– Prepare Android Environment
      run: |
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        
        # Accept Android licenses
        yes | $HOME/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager --licenses 2>/dev/null || true
      timeout-minutes: 10
    
    # 7. BUILD APK (WITH SMART RETRY)
    - name: ğŸ—ï¸ Build Android APK
      run: |
        set -e  # Exit on error
        
        echo "ğŸš€ Starting APK build process..."
        echo "ğŸ“± Target: Android API 33"
        echo "ğŸ Python: $(python --version)"
        echo "ğŸ› ï¸ Buildozer: $(buildozer --version 2>/dev/null || echo 'version check failed')"
        
        MAX_RETRIES=3
        RETRY_COUNT=0
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          echo ""
          echo "ğŸ”„ Build attempt $((RETRY_COUNT + 1))/$MAX_RETRIES"
          
          if buildozer -v android debug 2>&1 | tee build.log; then
            echo ""
            echo "âœ… BUILD SUCCESSFUL!"
            
            # Check if APK was created
            if ls bin/*.apk 1> /dev/null 2>&1; then
              APK_FILE=$(ls bin/*.apk | head -1)
              APK_SIZE=$(du -h "$APK_FILE" | cut -f1)
              echo "ğŸ“¦ APK Generated: $APK_FILE"
              echo "ğŸ“Š APK Size: $APK_SIZE"
              
              # Display APK info
              echo "ğŸ“± APK Info:"
              $HOME/.buildozer/android/platform/android-sdk/build-tools/*/aapt dump badging "$APK_FILE" | grep -E "package:|launchable-activity:" | head -2
              
              break
            else
              echo "âš ï¸ Build succeeded but no APK found in bin/"
              ls -la bin/ 2>/dev/null || echo "bin/ directory doesn't exist"
            fi
            break
          else
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "âŒ Build failed (Attempt $RETRY_COUNT/$MAX_RETRIES)"
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "â³ Waiting 30 seconds before retry..."
              sleep 30
              
              # Clean partial build
              echo "ğŸ§¹ Cleaning partial build..."
              buildozer android clean 2>/dev/null || true
            else
              echo "ğŸ’¥ All build attempts failed"
              echo "ğŸ“‹ Last 50 lines of build log:"
              tail -50 build.log
              exit 1
            fi
          fi
        done
      timeout-minutes: 60
    
    # 8. UPLOAD APK ARTIFACT
    - name: ğŸ“¤ Upload APK Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: sinux-android-apk
        path: bin/*.apk
        retention-days: 30
        if-no-files-found: error
        overwrite: true
    
    # 9. UPLOAD BUILD LOGS (ON FAILURE)
    - name: ğŸ“‹ Upload Build Logs (Debug)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-debug-logs
        path: |
          build.log
          .buildozer/
        retention-days: 7
    
    # 10. SUCCESS NOTIFICATION
    - name: ğŸ‰ Display Success Info
      if: success()
      run: |
        echo ""
        echo "========================================="
        echo "ğŸŠ SINUX APK BUILT SUCCESSFULLY! ğŸŠ"
        echo "========================================="
        echo ""
        echo "ğŸ“± APK is available in the Artifacts section"
        echo "ğŸ“¦ Download: sinux-android-apk"
        echo ""
        echo "Next steps:"
        echo "1. Go to Repository â†’ Actions"
        echo "2. Click latest workflow run"
        echo "3. Download from Artifacts section"
        echo "4. Install on Android device"
        echo ""
        echo "ğŸ”§ Built with: GitHub Actions + Buildozer"
        echo "ğŸ Python ${{ matrix.python-version }}"
        echo "ğŸ¤– Android API 33"
        echo "========================================="
