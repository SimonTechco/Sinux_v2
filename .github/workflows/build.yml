name: Build APK
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          python3-pip \
          git \
          zip \
          unzip \
          libncurses5 \
          openjdk-11-jdk \
          zlib1g-dev
        
    - name: Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip wheel setuptools
        python3 -m pip install cython==0.29.33
        python3 -m pip install buildozer
        
    # FIXED: Heredoc syntax for buildozer.spec
    - name: Create buildozer.spec
      run: |
        cat << 'EOF' > buildozer.spec
[app]
title = SINUX OS
package.name = sinux
package.domain = org.simontech
source.dir = .
version = 1.0.0
requirements = python3
orientation = portrait
android.permissions = INTERNET
android.api = 33
android.ndk = 23b
android.sdk = 33
android.minapi = 21
android.gradle_dependencies = 
p4a.branch = develop
EOF
        
    - name: Build with retry
      run: |
        echo "Starting APK build..."
        for i in {1..3}; do
          echo "Attempt $i/3"
          if buildozer -v android debug; then
            echo "Build successful!"
            break
          else
            echo "Build attempt $i failed, retrying..."
            sleep 10
          fi
        done
        
    - name: Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: sinux-apk
        path: bin/*.apk
        retention-days: 7
        
    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: .buildozer/
        retention-days: 7
